---
title: "doomsayer_diagnostics"
output:
  html_document:
      keep_md: yes
      theme: united
  pdf_document:
date: '`r format(Sys.Date())`'
params:
  dev: no
  yaml_cfg: x
---

```{r setup, message=FALSE, warning=FALSE, echo=FALSE}
# knitr::opts_chunk$set(echo = TRUE)

# check and load packages
packages <- c("dplyr","tidyr","ggplot2","yaml", "devtools", "knitr", "corrr", "viridis")

package.check <- lapply(packages, FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
        install.packages(x, dependencies = TRUE)
        library(x, character.only = TRUE, silent=TRUE)
    }
})


if(params$dev){
  yaml_cfg <- "../demo/output/config.yaml"
} else {
  yaml_cfg <- params$yaml_cfg
}

# debug--paths generated from doomsayer.py refer are formatted for bash on Windows
# the sys.info check updates these paths with Windows format for proper loading in R
if(Sys.info()['sysname']=="Windows"){
  yaml_cfg <- gsub("/mnt/c", "C:", yaml_cfg)
}

yaml_args <- yaml.load_file(yaml_cfg)
if(Sys.info()['sysname']=="Windows"){
  yaml_args <- lapply(yaml_args, function(x) gsub("/mnt/c", "C:", x))
}

attach(yaml_args)
```


```{r load, echo=FALSE}
# read tables
keep_ids <- read.table(keep_path, header=F, stringsAsFactors=F)
drop_ids <- read.table(drop_path, header=F, stringsAsFactors=F)
spectra <- read.table(M_path, header=T, stringsAsFactors=F)
spectra_rates <- read.table(M_path_rates, header=T, stringsAsFactors=F)
sig_contribs <- read.table(W_path, header=T, stringsAsFactors=F)
sig_loads <- read.table(H_path, header=T, stringsAsFactors=F)
rmse <- read.table(RMSE_path, header=F, stringsAsFactors=F)
```


#### Mutation spectrum per sample (M matrix)

Heatmap to visualize mutational spectra across all samples

```{r M, echo=FALSE, eval=FALSE, fig.height = 12, fig.width = 24}
# overall distribution
spectra_long <- spectra %>%
  mutate(group=ifelse(ID %in% keep_ids$V1, "keep", "drop")) %>%
  group_by(group) %>%
  gather(subtype, count, 2:ncol(spectra)) %>%
  separate(subtype, c("category", "motif"), sep = "[.]")

# heatmap(as.matrix(spectra[,-1]))

ggplot(spectra_long, aes(x=motif, y=ID, fill=count))+
  geom_raster()+
  facet_wrap(~category, ncol=6, scales="free_x")+
  xlab("Subtypes")+
  ylab("IDs")+
  theme_bw()+
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank())
```

### Combined mutation spectrum

These plots shows the total number of observations in each subtype, combined across all samples

#### All samples

```{r dist, echo=FALSE, fig.height = 12, fig.width = 24}
# overall distribution
spectra2 <- spectra %>%
  mutate(group=ifelse(ID %in% keep_ids$V1, "keep", "drop")) %>%
  group_by(group) %>%
  gather(subtype, count, 2:ncol(spectra)) %>%
  separate(subtype, c("category", "motif"), sep = "[.]") %>%
  group_by(category, motif, group) %>%
  summarise(count=sum(count)) %>%
  group_by(group) %>%
  mutate(prop=count/sum(count)) %>%
  ungroup()

ggplot(spectra2, aes(x=motif, y=prop, fill=group, group=group))+
  geom_bar(stat="identity", position="dodge")+
  facet_wrap(~category, ncol=6, scales="free_x")+
  ylab("Contribution")+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()+
  theme(axis.text.x=element_text(angle=90, vjust=0, size=20),
        axis.text.y=element_text(size=20),
        axis.title.x=element_text(size=24),
        axis.title.y=element_text(size=24),
        legend.title=element_blank(),
        legend.text=element_text(size=20),
        strip.text=element_text(size=24))
        # legend.position="none")
```

<!-- #### Kept samples -->

```{r dist_keep, echo=FALSE, eval=FALSE, fig.height = 12, fig.width = 24}
# overall distribution
spectra2_keep <- spectra %>%
  dplyr::filter(ID %in% keep_ids$V1) %>%
  gather(subtype, count, 2:ncol(spectra)) %>%
  separate(subtype, c("category", "motif"), sep = "[.]") %>%
  group_by(category, motif) %>%
  summarise(count=sum(count))
  # gather(subtype, count, 2:ncol(spectra)) %>%
  # separate(subtype, c("category", "motif"), sep = "[.]") %>%
  # group_by(category, motif) %>%
  # summarise(count=sum(count))

ggplot(spectra2_keep, aes(x=motif, y=count, fill=category))+
  geom_bar(stat="identity")+
  facet_wrap(~category, ncol=6, scales="free_x")+
  theme_bw()+
  theme(axis.text.x=element_text(angle=90, vjust=0, size=20),
        axis.text.y=element_text(size=20),
        axis.title.x=element_text(size=24),
        axis.title.y=element_text(size=24),
        strip.text=element_text(size=24),
        legend.position="none")
```

<!-- #### Dropped samples -->

```{r dist_drop, echo=FALSE, eval=FALSE, fig.height = 12, fig.width = 24}
# overall distribution
spectra2_drop <- spectra %>%
  dplyr::filter(!(ID %in% keep_ids$V1)) %>%
  gather(subtype, count, 2:ncol(spectra)) %>%
  separate(subtype, c("category", "motif"), sep = "[.]") %>%
  group_by(category, motif) %>%
  summarise(count=sum(count))
  # gather(subtype, count, 2:ncol(spectra)) %>%
  # separate(subtype, c("category", "motif"), sep = "[.]") %>%
  # group_by(category, motif) %>%
  # summarise(count=sum(count))

if(nrow(spectra2_drop)!=0){
  ggplot(spectra2_drop, aes(x=motif, y=count, fill=category))+
    geom_bar(stat="identity")+
    facet_wrap(~category, ncol=6, scales="free_x")+
    theme_bw()+
    theme(axis.text.x=element_text(angle=90, vjust=0, size=20),
          axis.text.y=element_text(size=20),
          axis.title.x=element_text(size=24),
          axis.title.y=element_text(size=24),
          strip.text=element_text(size=24),
          legend.position="none")
} else {
  cat("No samples in drop list\n")
}
```

### Signature loadings (H matrix)

Describes how each mutation subtype is loaded into the r signatures

```{r sigloads, echo=FALSE, fig.height = 6, fig.width = 14}
# signature loadings
corrm <- sig_loads %>%
  gather(var, val, 2:ncol(sig_loads)) %>%
  spread(Sig, val) %>%
  dplyr::select(-var) %>%
  correlate


corrm
#
# mincor <- corrm %>%
#   dplyr::select(-rowname) %>%
#   min(na.rm=T)
#
# cat("Minimum correlation = ", mincor, "\n")
# if(mincor > 0.5)

sig_loads_long <- sig_loads %>%
  mutate(sumVar = rowSums(.[2:ncol(sig_loads)])) %>%
  rowwise() %>%
  mutate_each(funs(./sumVar), -Sig) %>%
  gather(subtype, loading, 2:ncol(sig_loads)) %>%
  separate(subtype, c("category", "motif"), sep = "[.]")

ggplot(sig_loads_long, aes(x=motif, y=loading, fill=Sig))+
  geom_bar(stat="identity")+
  facet_grid(Sig~category, scales="free")+
  scale_fill_viridis(discrete=TRUE)+
  theme_bw()+
  theme(axis.text.x=element_text(angle=90, vjust=0, size=10),
        axis.text.y=element_text(size=20),
        axis.title.x=element_text(size=24),
        axis.title.y=element_text(size=24),
        strip.text=element_text(size=24),
        legend.position="none")
```

### Signature contributions per sample (W matrix)

Proportion each signature contributes to the mutation spectrum in each individual sample

```{r sigs, echo=FALSE, fig.height = 12, fig.width = 24}
# signature contributions across samples
sig_contribs2 <- sig_contribs[complete.cases(sig_contribs),] %>%
  mutate(sumVar = rowSums(.[2:ncol(sig_contribs)])) %>%
  rowwise() %>%
  mutate_each(funs(./sumVar), -ID) %>%
  dplyr::select(-sumVar) %>%
  gather(signature, contribution, -ID)

ggplot(sig_contribs2,
  aes(x=ID, y=contribution, group=signature, fill=signature))+
  # geom_line()+
  geom_bar(stat="identity", position="stack")+
  scale_fill_viridis(discrete=TRUE)+
  theme_bw()+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
      axis.text.y=element_text(size=20),
      axis.title.x=element_text(size=24),
      axis.title.y=element_text(size=24),
      strip.text=element_text(size=24))
```

### Signature contributions per kept samples (W matrix)

Proportion each signature contributes to the mutation spectrum in each individual sample

```{r sigs_keep, echo=FALSE, fig.height = 12, fig.width = 24}
# signature contributions across samples
sig_contribs2 <- sig_contribs[complete.cases(sig_contribs),] %>%
  dplyr::filter(ID %in% keep_ids$V1) %>%
  mutate(sumVar = rowSums(.[2:ncol(sig_contribs)])) %>%
  rowwise() %>%
  mutate_each(funs(./sumVar), -ID) %>%
  dplyr::select(-sumVar) %>%
  gather(signature, contribution, -ID)

ggplot(sig_contribs2,
    aes(x=ID, y=contribution, group=signature, fill=signature))+
  # geom_line()+
  geom_bar(stat="identity", position="stack")+
  scale_fill_viridis(discrete=TRUE)+
  theme_bw()+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
      axis.text.y=element_text(size=20),
      axis.title.x=element_text(size=24),
      axis.title.y=element_text(size=24),
      strip.text=element_text(size=24))
```

### Signature contributions per dropped samples (W matrix)

Proportion each signature contributes to the mutation spectrum in each individual sample
```{r sigs_drop, echo=FALSE, fig.height = 12, fig.width = 24}
# signature contributions across samples
sig_contribs2 <- sig_contribs[complete.cases(sig_contribs),] %>%
  dplyr::filter(ID %in% drop_ids$V1) %>%
  mutate(sumVar = rowSums(.[2:ncol(sig_contribs)]),
         maxgp = apply(.[,2:ncol(sig_contribs)], 1, function(x) names(x)[which.max(x)])) %>%
  rowwise() %>%
  mutate_each(funs(./sumVar), -c(ID,maxgp)) %>%
  dplyr::select(-sumVar) %>%
  gather(signature, contribution, -c(ID,maxgp)) #%>%
  # mutate(contribution=ifelse((ID %in% drop_ids$V1), contribution, 0))

ggplot(sig_contribs2,
    aes(x=ID, y=contribution,
      group=signature, fill=signature))+
  # geom_line()+
  geom_bar(stat="identity", position="stack")+
  scale_fill_viridis(discrete=TRUE)+
  facet_wrap(~maxgp, ncol=1, scales="free_x")+
  theme_bw()+
  theme(axis.text.x=element_blank(),
    # axis.text.x=element_text(angle=90, size=18),
        axis.ticks.x=element_blank(),
      axis.text.y=element_text(size=20),
      axis.title.x=element_text(size=24),
      axis.title.y=element_text(size=24),
      strip.text=element_text(size=24))

# sig1 <- sig_contribs2 %>%

# ddf<-data.frame(matrix(drop_ids$V1, round(sqrt(nrow(drop_ids)))+1, round(sqrt(nrow(drop_ids)))))
#
# knitr::kable(ddf, caption="Dropped samples list")
```

```{r rmse, echo=FALSE, fig.height = 12, fig.width = 24}
names(rmse) <- c("ID", "RMSE")

rmse <- rmse %>%
  mutate(ID=factor(ID, levels=ID[order(rmse$RMSE)])) %>%
  arrange(desc(RMSE)) %>%
  head(50)

rmse <- merge(rmse, sig_contribs2, by="ID")
d2a <- rmse %>%
  gather(k1,k2,RMSE,contribution) %>%
  mutate(key=ifelse(k1=="RMSE", "rk", signature))

 #%>%
  # mutate(k2=k2/50)
rsme_plot <- d2a %>%
  dplyr::filter(k1 == "RMSE") %>%
  mutate(k2=-k2) %>%
  distinct(ID, .keep_all=TRUE)

plotmin <- floor(min(rsme_plot$k2)/0.005)*0.005
# ceiling(x/u)*u
contribution_plot <- d2a %>%
  dplyr::filter(k1 != "RMSE") %>%
  mutate(k2=abs(plotmin)*k2)

breaks <- c(plotmin, plotmin/2, seq(0,abs(plotmin),abs(plotmin)/4))
labels <- c(abs(plotmin), abs(plotmin)/2, seq(0,1,0.25))

ggplot()+
  geom_bar(data=contribution_plot,
    aes(x=ID, y=k2, fill=key), stat="identity")+
  # geom_text(data=d2a, aes(x=ID, y=0.1, label=ID)) +
  geom_bar(data=rsme_plot,
    aes(x=ID, y=k2), stat="identity", width=0.08)+
  geom_point(data=rsme_plot,
    aes(x=ID, y=k2), size = 6, colour="red") +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = 0,
    fill = "blue", alpha = .1, color = NA)+
  annotate("text", x = length(unique(d2a$ID))+4, y = min(rsme_plot$k2)/2,
    label = "RMSE", size=8, vjust=1) +
  annotate("text", x = length(unique(d2a$ID))+4, y = abs(plotmin/2),
    label = "Signature contribution", size=8, vjust=1) +
  geom_hline(yintercept=0, linetype="dashed")+
  scale_y_continuous(limits=c(plotmin, abs(plotmin)+abs(plotmin)/10),
    breaks=breaks, labels=labels)+
  scale_fill_viridis(discrete=TRUE) +
  coord_flip()+
  theme_bw()+
  theme(axis.text.x=element_text(size=18))

```
