```{r heatmap, message=FALSE, warning=FALSE, echo=FALSE, fig.height = 18, fig.width = 14}

cutoff <- ifelse(ncol(spectra_rates)-1==6, 0.05, 0.005)
nind <- 100
# names(rmse) <- c("ID", "RMSE")

p<-sig_contribs %>% 
  gather(signature, value, -ID) %>% 
  ggplot(aes(x=value))+
    geom_histogram(bins=500)+
    facet_grid(signature~.)+
    theme_bw()

ggplotly(p)

sig_contribs2 <- sig_contribs[complete.cases(sig_contribs),] %>%
  # mutate(sumVar = rowSums(.[2:ncol(sig_contribs)])) %>%
  mutate(sumVar = rowSums(.[2:ncol(sig_contribs)])) %>%
  # dplyr::filter(sumVar>=500) %>%
  mutate_at(vars(starts_with("S")), funs(./sumVar)) %>%
  mutate(maxgp = apply(.[,2:ncol(sig_contribs)], 1, function(x)
    names(x)[which.max(x)])) %>%
  dplyr::select(-sumVar) %>%
  gather(signature, contribution, -c(ID,maxgp))

spectra_r <- spectra_rates %>%
  mutate_at(vars(-1), funs(./mean(.))) %>%
  gather(subtype, err, 2:ncol(spectra_rates)) %>%
  separate(subtype, c("category", "motif"), sep = "[.]") %>%
  mutate(err=ifelse(err>3, 3, err))

outlier_IDs <- drop_ids$V1

outlier_r_m <- spectra_r %>%
  dplyr::filter(ID %in% outlier_IDs) %>%
  # mutate(ID=factor(ID, levels=levels(outlier_IDs))) %>%
  mutate(subtype=paste0(category, "_", motif)) %>%
  dplyr::select(ID, subtype, err) %>%
  spread(subtype, err)

rownames(outlier_r_m) <- outlier_r_m$ID

outlier_r_m <- outlier_r_m %>%
  dplyr::select(-ID)

ncl = length(unique(sig_contribs2$signature))
# ncl = nrow(combinations(length(unique(sig_contribs2$signature)), 2, replace=T))

hrm <- heatmapr(outlier_r_m,
    k_row=ncl,
    Colv=TRUE,
    label_names = c("ID", "subtype", "error"),
    hclust_method="ward.D2")

# get_leaves_branches_col(hrm$rows)

hm <- heatmaply(outlier_r_m,
    k_row=ncl,
    Colv=TRUE,
    return_ppxpy=TRUE,
    hclust_method="ward.D2",
    colors=magma(20),
    label_names = c("ID", "subtype", "error"),
    column_text_angle = 90,
    subplot_widths=c(0.95,0.05),
    plot_method="ggplot")

subplot(hm$p, hm$px,
    margin=0, titleX=TRUE, shareY=TRUE, widths=c(0.9, 0.1)) %>%
  layout(autosize=F,
    width = 1400,
    height = 1400,
    margin = list(l = 130, b = 100))

```
